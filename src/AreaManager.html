<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, initial-scale=1.0, minimum-scale=0.5, maximum-scale=2.0, user-scalable=yes"/>
    <title>配送区域管理</title>
    <link href="css/bootstrap.min.css" rel="stylesheet">
    <!--<link rel="stylesheet" type="text/css" href="css/htmleaf-demo.css">-->
    <link href="css/main.css" rel="stylesheet">
    <script src="http://cdn.static.runoob.com/libs/jquery/1.10.2/jquery.min.js"></script>
    <script type="text/javascript"
            src="http://webapi.amap.com/maps?v=1.3&key=a5b9e30c2f2aa97f869eb8d27c42a8d6"></script>
    <script type="text/javascript">
        $("#distpicker2").distpicker({
            placeholder: true,
            autoSelect: false,
            province: "---- 所在省 ----",
            city: "---- 所在市 ----",
            district: "---- 所在区 ----"
        });
    </script>
</head>
<body>

<form class="form-inline">
    <div id="distpicker2" data-toggle="distpicker">
        <div class="form-group">
            <label class="sr-only" for="province1">Province</label>
            <select class="form-control" id="province1" data-province="广东省" disabled></select>
        </div>
        <div class="form-group">
            <label class="sr-only" for="city1">City</label>
            <select class="form-control" id="city1" data-city="---- 选择市 ----" onchange="selected_2()"></select>
        </div>
        <div class="form-group">
            <label class="sr-only" for="district1">District</label>
            <select class="form-control" id="district1" data-district="---- 选择区 ----" onchange="selected()"></select>
        </div>

    </div>
</form>

<div id="container" style="width:500px; height:300px"></div>
<input type="text" readonly="readonly" id="lnglat" style="width:500px; height:20px;">
<div class="button_group" id="button_group">
    <div style="float: left;width: 40px;height: 20px;padding-right: 20px">
        <button class="btn_add" onclick="addArea()" style="width: 100px; height: 40px;">新增区域</button>
        <button class="drawArea" style="width: 100px; height: 40px;">画面</button>
        <button class="confirm" style="width: 100px; height: 40px;">确认新增区域</button>
    </div>

    <div style="float: left;width: 40px;height: 100px; padding-left: 100px">
        <button class="btn_change" onclick="changeArea()" style="width: 100px; height: 40px;">修改区域</button>

    </div>
    <div style="float: left;width: 40px;height: 20px;padding-left: 100px">

        <button class="btn_delete" onclick="deleteArea()" style="width: 100px; height: 40px;">删除区域</button>
    </div>
</div>
<script>

    var province;
    var city;
    var district;
    var area;
    var map;
    $(function () {
        $("#distpicker2").distpicker({
            placeholder: true,
            autoSelect: false,
            province: "---- 所在省 ----",
            city: "---- 所在市 ----",
            district: "---- 所在区 ----"
        });
        map = new AMap.Map('container', {
            resizeEnable: true,
            zoom: 11,
        });
        map.setCity("广东省");
    })
    window.onload = function () {

        province = $('#province1 option:selected').text();

        area = province;

        document.getElementById("lnglat").value = area;

    }

    var marker;
    var markerArray = new Array();
    var geocoder;
    var lnglatArray = new Array();
    var polygon;
    var flag = false;
    var judgeArray = new Array();
    var addArea = function () {
        AMap.service('AMap.Geocoder', function () {//回调函数
            //实例化Geocoder
            geocoder = new AMap.Geocoder({
                city: "020"//城市，默认：“全国”
            });
            //TODO: 使用geocoder 对象完成相关功能
        });

        map.on('click', drawMarker, 1);
    };

    var drawMarker = function (e) {
        marker = new AMap.Marker({
            map: map,
            position: e.lnglat,
            clickable: false,
            cursor: 'move',
            raiseOnDrag: true,
            draggable: true,
        });

        geocoder.getAddress(e.lnglat, function (status, result) {
            if (status === 'complete' && result.info === 'OK') {
                document.getElementById("lnglat").value = result.regeocode.formattedAddress;
                //获得了有效的地址信息:
                //即，result.regeocode.formattedAddress
            } else {
                //获取地址失败
                document.getElementById("lnglat").value = "error";
            }
        });

        marker.on('dragging', move, 3);
        markerArray.push(marker);
    };

    var move = function () {
        drawArea();
        drawArea();
    };

    var changeArea = function () {

    };

    var deleteArea = function () {

    };
    $('.drawArea').click(function(){
        drawArea ();

    })
    function drawArea () {
        lnglatArray.splice(0, lnglatArray.length);
        for (var i = 0; i < markerArray.length; i++) {
            var marker = markerArray[i];
            var element = [marker.getPosition().getLng(), marker.getPosition().getLat()];
            lnglatArray.push(element);
        }
        if (!flag) {
            polygon = new AMap.Polygon({
                map: map,
                path: lnglatArray,
                bubble: true,
                strokeWeight:0,
                fillOpacity:0.5,
                fillColor:'#6495ED',
            });
            flag = true;
        } else {
            polygon.setMap(null);
            // polygon.setMap(map);
            flag = false;
            //polygon.setPath(lnglatArray);
        }
    };



    var confirm = $('.confirm').click(function () {
        for (var i =0; i<markerArray.length;i++) {
            var marker = markerArray[i];
            marker.hide();
        }
        markerArray.splice(0, markerArray.length);
        map.off('click', drawMarker, 1);
    });

    var selected_2 = function () {
        province = document.getElementById("province1").value;
        city = document.getElementById("city1").value;
        // district = $('#district1 option:selected').text();
        area = province + city;
        document.getElementById("lnglat").value = area;
        map.setCity(city);
    }

    var selected = function () {
        province = document.getElementById("province1").value;
        city = document.getElementById("city1").value;
        district = document.getElementById("district1").value;
        area = province + city + district;
        map.setCity(district);
        document.getElementById("lnglat").value = area;
    }


</script>


<script src="js/jquery.min.js" type="text/javascript"></script>
<script src="js/bootstrap.min.js"></script>
<script src="js/distpicker.data.js"></script>
<script src="js/distpicker.js"></script>
<script src="js/main.js"></script>
</body>
</html>
